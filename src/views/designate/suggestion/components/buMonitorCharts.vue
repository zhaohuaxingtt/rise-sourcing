<template>
  <div class="buNonitorCharts">
    <div class="margin-bottom20 clearFloat">
      <span class="font18 font-weight">
        {{ title }}
      </span>
    </div>
    <div class="legendLine">
      <ul class="legend">
        <li v-for="(item, index) in supplier" :key="index">
          <i :style="`background: ${colorPanel[index]}`"></i>
          {{item}}
        </li>
        <!-- <li>SH Huashi</li>
        <li class="corlor1">NBHX</li> -->
      </ul>
      <div class="control">
        <!-- 方案选择 -->
        <iSelect
          popper-class="mapControl"
          v-model="mapControl"
          @change="load"
          :multiple="true"
          :placeholder="$t('nominationSuggestion.FanAnXuanZhe')">
          <!-- <el-option
            value=""
            :label="$t('nominationSuggestion.FanAnXuanZhe') | capitalizeFilter"
          ></el-option> -->
          <el-option
            :value="items.key"
            :label="items.value"
            v-for="(items, index) in mapOptions"
            :key="index"
          ></el-option>
        </iSelect>
      </div>
    </div>
    <div id="charts0"></div>
  </div>
</template>
<script>
import { iSelect } from "rise";
import echarts from "@/utils/echarts";
import {rich} from './lib/chart'
import {
  colorPanel
} from './data'
import _ from 'lodash'

export default {
  components: {
    iSelect
  },
  props: {
    title: {
      type: String,
      default: 'Nomination Scenario Overview'
    },
    data: {
      type: Object,
      default: () => ({})
    },
    // 供应商数组
    supplier: {
      type:Array,
      default: () => ({})
    }
  },
  data() {
    return {
      mapControl: [],
      mapOptions: [
        {
          key: 0,
          value: '整体最佳'
        },
        {
          key: 1,
          value: '分组最佳'
        },
        {
          key: 2,
          value: '单一零件最佳'
        },
        {
          key: 3,
          value: '手动分配'
        }
      ],
      dataList: [],
      // 色板
      colorPanel
      
    }
  },
  mounted() {
  },
  methods: {
    load() {
      const vm = echarts().init(document.getElementById("charts0"));
      const self = this
      const bgColor = '#94c8fc'
      const mapControl = this.mapControl
      // 分组汇总 权重汇总
      
      const groupedInTotal = self.data.groupedInTotal
      const groupedWeightInTotal = self.data.groupedWeightInTotal
      this.$nextTick(() => {
        // 业务指标
        const quota = [
          'Best TTO \n for Whole Package',
          'Best TTO \n by Group',
          'Best TTO \n by Part',
          'Recommend \n Scenario']
        // xAxisData
        const xAxisData = !mapControl.length ? quota : mapControl.map(i => {
          return quota[i]
        })
        console.log('-load-', xAxisData, mapControl)
        // seriesData
        
        
        let series = this.genSeries()
        series.map(o => {
          if (mapControl.length) {
            const tarData = []
            const tmpData = _.cloneDeep(o.data)
            tmpData.forEach((item, index) => {
              if (mapControl.includes(index)) {
                tarData.push(item)
              }
            })
            o.data = tarData
          }
          return o
        })
        console.log('series', series)

        let option = {
          grid: {
            left: '10',
            right: '0',
            bottom: '0',
            top: '10%',
            containLabel: true
          },
          tooltip: {
            show: true,
            padding: 0,
            enterable: true,
            transitionDuration: 1,
            textStyle: {
                color: '#000',
                decoration: 'none',
            },
            formatter: function(params) {
              const wholePackage = self.data && self.data.wholePackage
              let tpl = ''

              // toolTip Best TTO \n for Whole Package
              params.dataIndex === 0 && (tpl = `
              <div class="toolTipBox-content">
                <p>Best TTO <br> for Whole Package: <span class="value">${params.data}</span></p>
              </div>`)

              // toolTip Best TTO \n by Group
              params.dataIndex === 1 && (tpl = `
              <div class="toolTipBox-content">
                <p>Compared to Best TTO <br> for Whole Package: 
                  <span class="value">${Number((params.data-wholePackage)/wholePackage*100).toFixed(2)}%</span>
                </p>
              </div>`)

              // toolTip Best TTO \n by Part
              params.dataIndex === 2 && (tpl = `
              <div class="toolTipBox-content">
                <p>Best TTO <br> by Part: <span class="value">${params.data}</span></p>
              </div>`)

              params.dataIndex === 3 && (tpl = `
              <div class="toolTipBox-content">
                <p>Compared to Best TTO <br> for Whole Package: 
                  <span class="value">${Number((params.data-wholePackage)/wholePackage*100).toFixed(2)}%</span>
                </p>
              </div>`)

              return `
              <div class="toolTipBox ${params.data === 0 ? 'hide' : ''}">
                ${tpl}
              </div>
              `
            }
          },
          xAxis: {
            type: 'category',
            offset: 0,
            // x轴数据
            data: xAxisData,
            axisTick: {
              show: false
            },
            axisLine:{
              lineStyle:{
                color: '#CDD4E2'
              }
            },
            axisLabel:{
              textStyle:{
                color: '#485465'
              },
              formatter: function (val) {
                // console.log(val)
                return `{n|${val}}` // 使用 rich 中的 n 来设置样式
              },
              rich,
              interval: 0 // 显示所有的 x 轴上的文字不隐藏
            },
            axisPointer: {  // 柱子背景
              show: true,
              type: 'shadow',
              shadowStyle: {
                color: '#cdd4E2',
                opacity: 0.13
              }
            },
          },
          yAxis: {
            type: 'value',
            axisTick: {
              show: false
            },
            axisLabel: {
              show: true
            },
            splitLine: {
              show: true, 
              lineStyle: {
                color: ['#ececf1']
              }
            },
            axisLine: {
              show: false
            },
        
          },
          series
        };
        // console.log(JSON.stringify(option))
        vm.setOption(option);
      })
    },
    genSeries() {
      const self = this
      const bgColor = '#dfeaf5'
      const textStyle = {
        color: '#efefef',
        fontSize: '10'
      }
      const series = []
      const wholePackageIndex = self.data.wholePackageIndex
      const wholePackage = self.data.wholePackage
      // Best TTO for Whole Package
      series.push({
        data: [wholePackage, '', '', ''],
        type: 'bar',
        barWidth: 30,
        stack: 'total',
        label: {
          show: true,
          position: 'top',
          textStyle: {
            color: '#485465'
          },
          formatter: wholePackage
        },
        itemStyle: {
          normal: {
            barBorderRadius: [5, 5, 0, 0],
            color: colorPanel[wholePackageIndex]
          },
        }
      })
      // Best TTO by Group
      const bestGroupSupplier = self.data.bestGroupSupplier
      const bestGroupSupplierMin = bestGroupSupplier && bestGroupSupplier[0]
      const bestGroupSupplierMax = bestGroupSupplier && bestGroupSupplier[1]
      const bestGroupSupplierMinIndex = self.data.bestGroupSupplierIndex
      
      const bestGroupSupplierTotal = bestGroupSupplier && bestGroupSupplier[2]
      let totalGroupPercent = 0

      console.log('----',bestGroupSupplier)
      
      series.push({
        data: ['', bestGroupSupplierMin, '', ''],
        type: 'bar',
        barWidth: 30,
        stack: 'total',
        label: {
          show: true,
          position: 'inside',
          textStyle,
          formatter: function(params) {
            const fz = Number(params.data)
            const fm = Number(bestGroupSupplierTotal)
            const percent = Math.floor(fz/fm*100)
            totalGroupPercent += percent
            return `${params.data}\n(${percent}%)`
          }
        },
        itemStyle: {
          normal: {
            barBorderRadius: [0, 0, 0, 0],
            color: colorPanel[bestGroupSupplierMinIndex]
          },
        }
      })
      series.push({
        data: ['', bestGroupSupplierMax, '', ''],
        type: 'bar',
        barWidth: 30,
        stack: 'total',
        label: {
          show: true,
          position: 'inside',
          textStyle,
          formatter: function(params) {
            const fz = Number(params.data)
            const fm = Number(bestGroupSupplierTotal)
            // const percent = Math.floor(fz/fm*100)
            const percent = 100 - totalGroupPercent
            return `${params.data}\n(${percent}%)`
          }
        },
        itemStyle: {
          normal: {
            barBorderRadius: [5, 5, 0, 0],
            color: bgColor
          },
        }
      })
      // 分组最佳柱子label
      bestGroupSupplierTotal&& (series.push({
        data: ['', 1, '', ''],
        type: 'bar',
        barWidth: 30,
        stack: 'total',
        label: {
          show: true,
          position: 'top',
          textStyle: {
            color: '#485465'
          },
          formatter: function() {
            return bestGroupSupplierTotal
          }
        },
        itemStyle: {
          normal: {
            barBorderRadius: [5, 5, 0, 0],
            color: bgColor
          },
        }
      }))

      // 单个零件最小
      const minPartSupplierTToArray = self.data.minPartSupplierTToArray
      const minPartSupplierTToTotal = self.data.minPartSupplierTToTotal
      let partPercent = 0
  
      minPartSupplierTToArray.forEach((item, index) => {
        series.push({
          data: ['', '', item.data, ''],
          type: 'bar',
          barWidth: 30,
          stack: 'total',
          label: {
            show: true,
            position: 'inside',
            textStyle,
            formatter: function(params) {
              const fz = Number(params.data)
              const fm = Number(minPartSupplierTToTotal)
              const percent =(item.index === minPartSupplierTToArray.length - 1) ? (100 - partPercent) : Math.floor(fz/fm*100)
              partPercent += percent
              return `${params.data}\n(${percent}%)`
            }
          },
          itemStyle: {
            normal: {
              barBorderRadius: item.index === (minPartSupplierTToArray.length - 1) ? [5, 5, 0, 0] : [0, 0, 0, 0],
              color: colorPanel[item.index]
            },
          }
        })
      })
      // 零件最佳柱子label
      minPartSupplierTToTotal&& (series.push({
        data: ['', '', 1, ''],
        type: 'bar',
        barWidth: 30,
        stack: 'total',
        label: {
          show: true,
          position: 'top',
          textStyle: {
            color: '#485465'
          },
          formatter: function() {
            return minPartSupplierTToTotal
          }
        },
        itemStyle: {
          normal: {
            barBorderRadius: [5, 5, 0, 0],
            color: bgColor
          },
        }
      }))

      // 权重柱状图
      const weightSupplier = self.data.weightSupplier || []
      const weightSupplierTotal = self.data.weightSupplierTotal || 0
      let totalPercent = 0
      weightSupplier.forEach((item, index) => {
        series.push({
          data: ['', '', '', item],
          type: 'bar',
          barWidth: 30,
          stack: 'total',
          label: {
            show: true,
            position: 'inside',
            textStyle,
            formatter: function(params) {
              const fz = Number(params.data)
              const fm = Number(weightSupplierTotal)
              const percent =(index === weightSupplier.length - 1) ? (100 - totalPercent) : Math.floor(fz/fm*100)
              totalPercent += percent
              return `${params.data}\n(${percent}%)`
            }
          },
          itemStyle: {
            normal: {
              barBorderRadius: index === (weightSupplier.length - 1) ? [5, 5, 0, 0] : [0, 0, 0, 0],
              color: colorPanel[index]
            },
          }
        })
      })
      // 最后一根柱子的label
      weightSupplierTotal && (series.push({
        data: ['', '', '', '1'],
        type: 'bar',
        barWidth: 30,
        stack: 'total',
        label: {
          show: true,
          position: 'top',
          textStyle: {
            color: '#485465'
          },
          formatter: function() {
            return weightSupplierTotal
          }
        },
        itemStyle: {
          normal: {
            barBorderRadius: [0, 0, 0, 0],
            color: '#ffffff'
          },
        }
      }))
      return series
    }
  },
  watch: {
    data: {
      handler(newVal) {
        this.dataList = (newVal && newVal.data) || []
        this.$nextTick(() => {
          this.load()
        })
      },
      immediate: true,
      deep: true
    },
    mapControl() {
      console.log(this.mapControl)
      this.load()
    }
  }
}
</script>

<style lang="scss" scoped>
.buNonitorCharts {
  width: 100%;
  height: 560px;
  .legendLine {
    display: flex;
    justify-content: space-between;
    padding-top: 10px;
    .legend {
      li {
        font-size: 16px;
        display: inline-block;
        padding-right: 15px;
        i {
          // content: '';
          display: inline-block;
          width: 10px;
          height: 10px;
          background: $color-blue;
          border-radius: 50%;
          margin-right: 5px;
        }
        &.corlor0:before {
          background: $color-blue;
        }
        &.corlor1:before {
          background: #94c8fc;
        }
      }
    }
  }
  #charts0 {
    width: 100%;
    height: 350PX;
  }
  ::v-deep.toolTipBox {
    background: #fff;
    border-radius: 5px;
    padding: 20px;
    border: 1px solid #efefef;
    &.hide {
      display: none !important;
    }
    p {
      font-size: 12px;
      font-weight: 100;
    }
    .value {
      font-size: 12px;
      color: #000;
      font-weight: 600;
      display: inline-block;
      padding-left: 10px;
    }
  }
}
.control {
  ::v-deep.el-select {
    .el-select__tags {
      height: 26px !important;
      overflow: hidden;
    }
  }
}
</style>
<style lang="scss">
.mapControl.el-select-dropdown {
  .el-select-dropdown__item {
    padding-left: 20px;
    &:after {
      left: 10px;
      right: auto !important;
      // content: '' !important;
      box-sizing: content-box;
      border: 1px solid #fff;
      border-left: 0;
      border-top: 0;
      height: 7PX;
      left: 4px;
      position: absolute;
      top: 1px;
      transform: rotate(45deg) scaleY(0);
      width: 3PX;
      transition: transform .15s ease-in .05s;
      transform-origin: center;
    }
  }
}
</style>